function send(){const e=document.getElementById("file");Promise.all([...e.files].map((e,t)=>{const r=new FileReader;return new Promise(t=>{r.onload=(r=>{const a=r.target.result.split(",");console.log(a),t({fileName:e.name,mimeType:a[0].match(/:(\w.+);/)[1],data:a[1]})}),r.readAsDataURL(e)})})).then(e=>{})}$("#email-to, #email-cc, #email-edit-cc").tagEditor({autocomplete:{delay:0,position:{collision:"flip"},source:["phuong.t.le@ap.averydennison.com","an.phan@ap.averydennison.com","vi.phan@ap.averydennison.com","anh.van@ap.averydennison.com","truc.nt.tran@ap.averydennison.com","thanhchau.vo@ap.averydennison.com","tham.tran@ap.averydennison.com","sang.phan@ap.averydennison.com"]},forceLowercase:!0,placeholder:"Add an email ..."}),$("#success-modal").modal("toggle"),$("#btn-lh").click(function(){$("#div-site").html("FRU IC Overseas"),$("#input-site").val("0"),$("#success-modal").modal("hide")}),$("#btn-fru").click(function(){$("#div-site").html("FRU IC LH"),$("#input-site").val("1"),$("#success-modal").modal("hide")}),$("#btn-site").click(function(){$("#success-modal").modal("toggle")});var atcFile=null,atcFileEdit=null;function getDataFail(e){$(".preload").removeClass("d-flex"),toastr.error("Error! Pls try again")}$("#file").FancyFileUpload({params:{action:"fileuploader"},maxfilesize:25e6,added:function(e,t){var r=[];t.map((e,t)=>{const a=new FileReader;a.readAsDataURL(e),a.onloadend=function(){const t=a.result.split(",");r.push({fileName:e.name,mimeType:t[0].match(/:(\w.+);/)[1],data:t[1]})}}),atcFile=r},deleted:function(e,t){var r=[];t.map((e,t)=>{const a=new FileReader;a.readAsDataURL(e),a.onloadend=function(){const t=a.result.split(",");r.push({fileName:e.name,mimeType:t[0].match(/:(\w.+);/)[1],data:t[1]})}}),atcFile=r}}),$("#fileEdit").FancyFileUpload({params:{action:"fileuploader"},maxfilesize:25e6,added:function(e,t){var r=[];t.map((e,t)=>{const a=new FileReader;a.readAsDataURL(e),a.onloadend=function(){const t=a.result.split(",");r.push({fileName:e.name,mimeType:t[0].match(/:(\w.+);/)[1],data:t[1]})}}),atcFileEdit=r},deleted:function(e,t){console.log(t);var r=[];t.map((e,t)=>{const a=new FileReader;a.readAsDataURL(e),a.onloadend=function(){const t=a.result.split(",");r.push({fileName:e.name,mimeType:t[0].match(/:(\w.+);/)[1],data:t[1]})}}),atcFileEdit=r}});var reg=/^\d+$/,table=jspreadsheet(document.getElementById("spreadsheet"),{minDimensions:[14,8],tableOverflow:!0,allowDeleteColumn:!1,allowManualInsertColumn:!1,allowInsertColumn:!1,rowResize:!0,columns:[{type:"dropdown",title:"Product line",width:"170",name:"productline",source:["Offset / Digital","Thermal","RFID HT","RFID SB","PFL","Woven","HTL","IPPS"]},{type:"dropdown",title:"Make/Buy",width:"80",name:"makebuy",source:["Make","Buy"]},{type:"text",title:"Customer Item Code",width:"150",name:"customeritem"},{type:"text",title:"RBO",width:"150",name:"rbo"},{type:"text",title:"Internal Item code",width:"150",name:"internalitem"},{type:"text",title:"Quantity",width:"80",name:"quantity"},{type:"calendar",title:"CRD",options:{format:"DD-Mon-YY"},width:"120",name:"crd"},{type:"text",title:"SO",width:"150",name:"so"},{type:"numeric",title:"SO line",width:"80",name:"soline",mask:"10"},{type:"text",title:"Remark",wordWrap:!0,width:"150",name:"remark"},{type:"text",title:"PO Number",width:"120",name:"ponumber"},{type:"text",title:"Web Order Number",width:"120",name:"weborder"},{type:"text",title:"Bill To",width:"120",name:"billto"},{type:"text",title:"Ship To",width:"120",name:"shipto"}],onbeforechange:function(e,t,r,a,o){return 0==r&&o?["Offset / Digital","Thermal","RFID HT","RFID SB","PFL","Woven","HTL","IPPS"].includes(o)?(t.style.border="",o):(t.style.border="1px solid red","!err"):1==r&&o?["Make","Buy"].includes(o)?(t.style.border="",o):(t.style.border="1px solid red","!err"):6==r&&o?o.length<6?(t.style.border="1px solid red","!err"):(t.style.border="",DateFormatter.formatDate(new Date(o),"YYYY-MM-DD")):8==r&&o?reg.test(o)?(t.style.border="",o):(t.style.border="1px solid red","!err"):o},onpaste:(e,t)=>t[0].length>14?(toastr.error("Value you just pasted is longer than the length of the table. Do not submit! Pls check again"),!1):t}),DateFormatter={monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],formatDate:function(e,t){var r=this;return t=r.getProperDigits(t,/d+/gi,e.getDate()),t=(t=r.getProperDigits(t,/M+/g,e.getMonth()+1)).replace(/y+/gi,function(t){var r=t.length,a=e.getFullYear();return 2==r?(a+"").slice(-2):4==r?a:t}),t=r.getProperDigits(t,/H+/g,e.getHours()),t=r.getProperDigits(t,/h+/g,r.getHours12(e.getHours())),t=r.getProperDigits(t,/m+/g,e.getMinutes()),t=(t=r.getProperDigits(t,/s+/gi,e.getSeconds())).replace(/a/gi,function(t){var a=r.getAmPm(e.getHours());return"A"===t?a.toUpperCase():a}),t=r.getFullOr3Letters(t,/d+/gi,r.dayNames,e.getDay()),t=r.getFullOr3Letters(t,/M+/g,r.monthNames,e.getMonth())},getProperDigits:function(e,t,r){return e.replace(t,function(e){var t=e.length;return 1==t?r:2==t?("0"+r).slice(-2):e})},getHours12:function(e){return(e+24)%12||12},getAmPm:function(e){return e>=12?"pm":"am"},getFullOr3Letters:function(e,t,r,a){return e.replace(t,function(e){var t=e.length;return 3==t?r[a].substr(0,3):4==t?r[a]:e})}};function validateEmail(e){return/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())}function insertRow(){var e=parseInt(document.getElementById("txtRow").value);table.insertRow(e)}$("#tblVal").val(JSON.stringify(table.getJson()));var frm=$("form#formAddNew").serialize();function constructTable(e){for(var t=Headers(e)[1],r=Headers(e)[0],a=$("<table/>"),o=0;o<e.length;o++){for(var l=$("<tr/>"),n=0;n<r.length;n++){var i=e[o][r[n]];null==i&&(i=""),l.append($("<td/>").html(i))}a.append($("<tr/>").append(l.html()))}return"<table border='1' cellspacing='0' cellpadding='5'>"+t+a.html()+"</table>"}function Headers(e){for(var t=["Product line","Make/Buy","Customer Item Code","RBO","Internal Item Code","Quantity","CRD","SO","SO line","Remark","PO Number","Web Order Number","Bill To","Ship To"],r=[],a=$("<table/>"),o=$("<tr/>"),l=0;l<e.length;l++){var n=e[l],i=0;for(var s in n)-1==$.inArray(s,r)&&(r.push(s),o.append($("<th/>").html(t[i])),i++)}return a.append($("<tr/>").append(o.html())),[r,a.html()]}$(document).on("click",".btnAddNew",function(){var e=$(".txtEmail").val();if(""==e)return toastr.error("Email is null!"),!1;var t=0;e.split(",").forEach((e,r)=>{if(!validateEmail(e))return toastr.error("Invalid email!"),t++,!1});var r=$(".txtCc").val();if(r.split(",").forEach((e,r)=>{if(!validateEmail(e))return toastr.error("Invalid email!"),t++,!1}),t>0)return!1;if(""==$("#input-site").val())return $("#success-modal").modal("toggle"),!1;$(".preload").addClass("d-flex");var a=table.getJson();if($("#tblVal").val(JSON.stringify(a)),$("form#formAddNew").serialize()==frm)return $(".preload").removeClass("d-flex"),toastr.warning("Nothing to change! Nothing gonna change my love for u"),!1;$.ajax({url:"https://script.google.com/a/ap.averydennison.com/macros/s/AKfycbx6VNwAo8gj0bwvGMjvJlswt8Eaok8kRmIrxJoL7MKLIirhQFb_/exec",dataType:"JSONP",async:!1,jsonpCallback:"callback",type:"GET",success:function(t){for(var o=[],l=[],n=0,i=a.filter(e=>!Object.keys(e).every(t=>""==e[t])),s=Object.values(i.reduce((e,t)=>{let r=t.so+"-"+t.soline;return e[r]=e[r]||[],e[r].push(t),e},{})),d=0;d<s.length;d++)if(s[d].length>1)return $(".preload").removeClass("d-flex"),toastr.error(s[d][0].so+"-"+s[d][0].soline+" is duplicate."),!1;for(d=0;d<i.length;d++){var u=0;for(var m in a[d]){if(""===a[d][m]&&u<9&&"customeritem"!=m)return $(".preload").removeClass("d-flex"),toastr.error(m+" at row "+(d+1)+" is blank. Pls check again!"),!1;u++}if("!err"==a[d].productline)return $(".preload").removeClass("d-flex"),toastr.error("Product line: Invalid value at row: "+(d+1)+". Pls check again"),!1;if("!err"==a[d].makebuy)return $(".preload").removeClass("d-flex"),toastr.error("Make/Buy: Invalid value at row: "+(d+1)+". Pls check again"),!1;if("!err"==a[d].crd||"NamN-amN-amN"==a[d].crd)return $(".preload").removeClass("d-flex"),toastr.error("CRD: Invalid format at row: "+(d+1)+". Pls check again"),!1;if(!reg.test(a[d].so))return $(".preload").removeClass("d-flex"),toastr.error("SO: Invalid format at row: "+(d+1)+". Only number. Pls check again"),!1;if(!reg.test(a[d].quantity))return $(".preload").removeClass("d-flex"),toastr.error("Quantity: Invalid format at row: "+(d+1)+". Only number. Pls check again"),!1;if(!reg.test(a[d].soline))return $(".preload").removeClass("d-flex"),toastr.error("SO line: Invalid format at row: "+(d+1)+". Only number. Pls check again"),!1;if(n++,a[d].crd=DateFormatter.formatDate(new Date(a[d].crd),"D-MMM-YY"),l.push(a[d]),14!=Object.keys(a[d]).length)return $(".preload").removeClass("d-flex"),toastr.error("Total column != 14. Pls check again"),!1;var c=[],p={productline:"",makebuy:"",customeritem:"",rbo:"",supplier:"",internalitem:"",quantity:"",revquant:"",icp:"",ladderprice:"",finalsupplier:"",crd:"",so:"",soline:"",linkpo:"",pono:"",porelease:"",postt:"",buyer:"",ic:"",supportsite:"",etd:"",eta:"",purremark:"",remark:"",ponumber:"",weborder:"",billto:"",shipto:""};for(var m in a[d])p.hasOwnProperty(m)&&(p[m]=a[d][m]);Object.keys(p).every(e=>c.push(p[e])),c.push(e.trim()),c.push(r.trim()),o.push(c)}if(0==n)return $(".preload").removeClass("d-flex"),toastr.error("Do not submit null value!"),!1;var f=$("#input-site").val(),h=constructTable(l);frm=$("form#formAddNew").serialize(),google.script.run.withFailureHandler(getDataFail).withSuccessHandler(function(e){if(e.d)return $(".preload").removeClass("d-flex"),toastr.error("SO-SO line: "+e.so+" already exists. Pls check again!"),!1;$(".preload").removeClass("d-flex"),toastr.success("Done. Email sent successfully")}).AddNew(o,h,t,atcFile,f)},error:function(){return toastr.error("Error when get token apps script"),!1}})});var tableEdit=null,frmEdt=null,frmSearch=$("form.frmSearch").serialize();$(document).on("click",".btnSearch",function(){if($("form.frmSearch").serialize()==frmSearch)return toastr.warning("Nothing to change! Nothing gonna change my love for u"),!1;$(".preload").addClass("d-flex"),$("#spreadsheetEdit").html("");var e=$(".txtSearch").val();if(""==e)return $(".preload").removeClass("d-flex"),toastr.error("Searchbox is null!"),!1;frmSearch=$("form.frmSearch").serialize(),google.script.run.withFailureHandler(getDataFail).withSuccessHandler(searchResult).searchRequest(e)});var arrInfo=null;function searchResult(e){if(0==e.length)return tableEdit=null,$(".preload").removeClass("d-flex"),toastr.error("Not found!"),!1;arrInfo=[],e.map((e,t)=>{var r=e.splice(15,7);r.unshift(e.splice(0,1)),arrInfo.push(r)}),$(".txtCount").val(e.length),tableEdit=jspreadsheet(document.getElementById("spreadsheetEdit"),{data:e,minDimensions:[14,8],allowDeleteColumn:!1,allowManualInsertColumn:!1,allowInsertColumn:!1,rowResize:!0,columns:[{type:"dropdown",title:"Product line",width:"170",name:"productline",source:["Offset / Digital","Thermal","RFID HT","RFID SB","PFL","Woven","HTL","IPPS"]},{type:"dropdown",title:"Make/Buy",width:"80",name:"makebuy",source:["Make","Buy"]},{type:"text",title:"Customer Item Code",width:"150",name:"customeritem"},{type:"text",title:"RBO",width:"150",name:"rbo"},{type:"text",title:"Internal Item code",width:"150",name:"internalitem"},{type:"text",title:"Quantity",width:"80",name:"quantity"},{type:"calendar",title:"CRD",options:{format:"DD-Mon-YY"},width:"120",name:"crd"},{type:"text",title:"SO",width:"150",name:"so"},{type:"numeric",title:"SO line",width:"80",name:"soline",mask:"10"},{type:"text",title:"Remark",wordWrap:!0,width:"150",name:"remark"},{type:"text",title:"PO Number",width:"120",name:"ponumber"},{type:"text",title:"Web Order Number",width:"120",name:"weborder"},{type:"text",title:"Bill To",width:"120",name:"billto"},{type:"text",title:"Ship To",width:"120",name:"shipto"}],onbeforechange:function(e,t,r,a,o){return 0==r&&o?["Offset / Digital","Thermal","RFID HT","RFID SB","PFL","Woven","HTL","IPPS"].includes(o)?(t.style.border="",o):(t.style.border="1px solid red","!err"):1==r&&o?["Make","Buy"].includes(o)?(t.style.border="",o):(t.style.border="1px solid red","!err"):6==r&&o?o.length<6?(t.style.border="1px solid red","!err"):(t.style.border="",DateFormatter.formatDate(new Date(o),"YYYY-MM-DD")):8==r&&o?reg.test(o)?(t.style.border="",o):(t.style.border="1px solid red","!err"):o},onpaste:(e,t)=>t[0].length>14?(toastr.error("Value you just pasted is longer than the length of the table. Do not submit! Pls check again"),!1):t}),$(".preload").removeClass("d-flex"),$("#tblEdt").val(JSON.stringify(tableEdit.getJson())),frmEdt=$("form#formEdit").serialize()}$(document).on("click",".btnEdit",function(){if(""==$("#input-site").val())return $("#success-modal").modal("toggle"),!1;if(null!=tableEdit){var e=$(".txtEmailEdit").val(),t=tableEdit.getJson();if($("#tblEdt").val(JSON.stringify(t)),$(".preload").addClass("d-flex"),$("form#formEdit").serialize()==frmEdt)return $(".preload").removeClass("d-flex"),toastr.warning("Nothing to change! Nothing gonna change my love for u"),!1;$.ajax({url:"https://script.google.com/a/ap.averydennison.com/macros/s/AKfycbx6VNwAo8gj0bwvGMjvJlswt8Eaok8kRmIrxJoL7MKLIirhQFb_/exec",dataType:"JSONP",async:!1,jsonpCallback:"callback",type:"GET",success:function(r){for(var a=[],o=[],l=0,n=t.filter(e=>!Object.keys(e).every(t=>""==e[t])),i=Object.values(n.reduce((e,t)=>{let r=t.so+"-"+t.soline;return e[r]=e[r]||[],e[r].push(t),e},{})),s=0;s<i.length;s++)if(i[s].length>1)return $(".preload").removeClass("d-flex"),toastr.error(i[s][0].so+"-"+i[s][0].soline+" is duplicate."),!1;for(s=0;s<n.length;s++){var d=0;for(var u in t[s]){if(""===t[s][u]&&d<9&&"customeritem"!=u)return $(".preload").removeClass("d-flex"),toastr.error(u+" at row "+(s+1)+" is blank. Pls check again!"),!1;d++}if("!err"==t[s].productline)return $(".preload").removeClass("d-flex"),toastr.error("Product line: Invalid value at row: "+(s+1)+". Pls check again"),!1;if("!err"==t[s].makebuy)return $(".preload").removeClass("d-flex"),toastr.error("Make/Buy: Invalid value at row: "+(s+1)+". Pls check again"),!1;if("!err"==t[s].crd||"NamN-amN-amN"==t[s].crd)return $(".preload").removeClass("d-flex"),toastr.error("CRD: Invalid format at row: "+(s+1)+". Pls check again"),!1;if(!reg.test(t[s].so))return $(".preload").removeClass("d-flex"),toastr.error("SO: Invalid format at row: "+(s+1)+". Only number. Pls check again"),!1;if(!reg.test(t[s].quantity))return $(".preload").removeClass("d-flex"),toastr.error("Quantity: Invalid format at row: "+(s+1)+". Only number. Pls check again"),!1;if(!reg.test(t[s].soline))return $(".preload").removeClass("d-flex"),toastr.error("SO line: Invalid format at row: "+(s+1)+". Only number. Pls check again"),!1;if(l++,t[s].crd=DateFormatter.formatDate(new Date(t[s].crd),"D-MMM-YY"),o.push(t[s]),14!=Object.keys(t[s]).length)return $(".preload").removeClass("d-flex"),toastr.error("Total column != 14. Pls check again"),!1;var m=[],c={productline:"",makebuy:"",customeritem:"",rbo:"",supplier:"",internalitem:"",quantity:"",revquant:"",icp:"",ladderprice:"",finalsupplier:"",crd:"",so:"",soline:"",linkpo:"",pono:"",porelease:"",postt:"",buyer:"",ic:"",supportsite:"",etd:"",eta:"",purremark:"",remark:"",ponumber:"",weborder:"",billto:"",shipto:""};for(var u in t[s])c.hasOwnProperty(u)&&(c[u]=t[s][u]);Object.keys(c).every(e=>m.push(c[e])),m.push(arrInfo[0][1]),m.push(e.trim()),a.push(m)}if(0==l)return $(".preload").removeClass("d-flex"),toastr.error("Do not submit null value!"),!1;if($(".txtCount").val()!=l)return $(".preload").removeClass("d-flex"),toastr.error("Do not insert or delete row. Pls check again!"),!1;var p=$("#input-site").val();frmEdt=$("form#formEdit").serialize();var f=constructTable(o);google.script.run.withFailureHandler(getDataFail).withSuccessHandler(function(e){if(e.d)return $(".preload").removeClass("d-flex"),toastr.error("SO-SO line: "+e.so+" already exists. Pls check again!"),!1;$(".preload").removeClass("d-flex"),toastr.success("Update done. Email sent successfully")}).Edit(a,arrInfo,f,r,atcFileEdit,p)},error:function(){return toastr.error("Error when get token apps script"),!1}})}});